# vi :set ft=ruby :
provider= "virtualbox"
master_name="edhommeeS"
worker_name="edhommeeSW"
master_ip= "192.168.42.110"
worker_ip= "192.168.42.111"

Vagrant.configure(2) do |config|
	config.vm.box = "generic/centos8"
	config.vm.box_url = "https://app.vagrantup.com/generic/boxes/centos8/versions/3.6.12/providers/virtualbox.box"
	config.vm.synced_folder ".", "/vagrant"
	config.vm.define master_name do |control|
		control.vm.hostname = master_name
		control.vm.network "private_network", ip: master_ip, hostname: true
		control.vm.provider provider do |v|
			v.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
			v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
			v.cpus = 1
			v.memory = "1024"
			v.name = master_name
		end
		control.vm.provision "shell", inline: <<-SHELL
			IPADDR=$(ip a show eth1 | grep "inet " | awk '{print $2}' | cut -d / -f1)
			curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--node-ip=${IPADDR} -flannel-iface=eth1 --write-kubeconfig-mode 644" sh -
			NODE_TOKEN="/var/lib/rancher/k3s/server/node-token"
			cat ${NODE_TOKEN}
			cp ${NODE_TOKEN} /vagrant/
			echo "alias k='kubectl'" >> /etc/profile.d/00-aliases.sh
			KUBE_CONFIG="/etc/rancher/k3s/k3s.yaml"
		SHELL
	end
	config.vm.define worker_name do |control|
		control.vm.hostname = worker_name
		control.vm.network "private_network", ip: worker_ip, hostname: true
		control.vm.provider provider do |v|
			v.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
			v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
			v.cpus = 1
			v.memory = "1024"
			v.name = worker_name
		end
		control.vm.provision "shell", inline: <<-SHELL
			IPADDR=$(ip a show eth1 | grep "inet " | awk '{print $2}' | cut -d / -f1)
			cat /vagrant/node-token
			curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--node-ip=${IPADDR} -flannel-iface=eth1" K3S_URL=https://192.168.42.110:6443 K3S_TOKEN=$(cat /vagrant/node-token) sh -
			echo "alias k='kubectl'" >> /etc/profile.d/00-aliases.sh
		SHELL
	end
end
